please see file src/engine/generate.cpp
